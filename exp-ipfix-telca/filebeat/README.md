# IPFIX to Kafka parser and exporter.
This repository contains an exporter used to collect, parser and transform [IPFIX](https://www.iana.org/assignments/ipfix/ipfix.xhtml) data to JSON format. Then, this information will be pushed into a Kafka Topic for further analysis.


## How to use
Build:
`sudo docker build -t filebeat_ipfix .`

Run:
`sudo docker run --add-host kafka:<kafka_ip> -p 4739:4739/udp filebeat_ipfix`

Launch IPFIX probe in OpenvSwitch:
`sudo ovs-vsctl -- set Bridge br0 ipfix=@i -- --id=@i create IPFIX targets=\"127.0.0.1:4739\" obs_domain_id=123 obs_point_id=456 cache_active_timeout=60 sampling=1`

Wait a few minutes until the templates are generated by the ipfix collector.
## Configuration
Kafka topic is specified inside `config/filebeat.yml`. Another parameters are also configurable in this file. 
[IPFIX Collector Configuration](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-netflow.html)
[Kafka Configuration](https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html)

## Output data example

An output data example can be founded in `data_example.txt`

```json
{
  "@timestamp": "2020-02-19T09:17:19.000Z",
  "@metadata": {
    "beat": "filebeat",
    "type": "_doc",
    "version": "7.6.0"
  },
  "source": {
    "mac": "08:00:27:cd:16:df",
    "packets": 1
  },
  "destination": {
    "mac": "08:00:27:9a:ac:3e"
  },
  "network": {
    "community_id": "1:LFE/FJ5zfsQGP8HTeu6b6rxLS78=",
    "packets": 1,
    "direction": "outbound"
  },
  "host": {
    "name": "ovs1"
  },
  "agent": {
    "type": "filebeat",
    "ephemeral_id": "fd582f1a-9303-4793-8bad-a6d8ac8b30f1",
    "hostname": "ovs1",
    "id": "2331ee72-fe2f-405f-8b75-954d7c67686f",
    "version": "7.6.0"
  },
  "observer": {
    "ip": "127.0.0.1"
  },
  "flow": {
    "id": "oFN7CMNpOLQ",
    "locality": "private"
  },
  "input": {
    "type": "netflow"
  },
  "ecs": {
    "version": "1.4.0"
  },
  "event": {
    "category": "network_traffic",
    "action": "netflow_flow",
    "created": "2020-02-19T09:17:19.000Z",
    "kind": "event"
  },
  "netflow": {
    "destination_mac_address": "08:00:27:9a:ac:3e",
    "interface_name": "enp0s8",
    "ethernet_type": 2054,
    "type": "netflow_flow",
    "ingress_broadcast_packet_total_count": 2557,
    "egress_interface_type": 0,
    "ingress_unicast_packet_total_count": 1264723,
    "flow_end_delta_microseconds": 944000,
    "layer2_octet_delta_count": 60,
    "dropped_packet_delta_count": 0,
    "source_mac_address": "08:00:27:cd:16:df",
    "ingress_multicast_packet_total_count": 2662,
    "exporter": {
      "version": 10,
      "timestamp": "2020-02-19T09:17:19.000Z",
      "uptime_millis": 0,
      "address": "127.0.0.1:33603",
      "source_id": 123
    },
    "ingress_interface_type": 0,
    "post_mcast_packet_total_count": 2751,
    "packet_total_count": 2459434,
    "egress_unicast_packet_total_count": 1184184,
    "layer2_octet_total_count": 3355017750,
    "dropped_packet_total_count": 2436787,
    "post_mcast_packet_delta_count": 0,
    "ethernet_header_length": 14,
    "flow_end_reason": 5,
    "interface_description": "",
    "ingress_interface": 4,
    "flow_direction": 1,
    "observation_point_id": 456,
    "egress_interface": 3,
    "packet_delta_count": 1,
    "flow_start_delta_microseconds": 944000,
    "egress_broadcast_packet_total_count": 2557
  }
}
```